if(NOT BUILD_TESTING)
        return()
endif()

include(FetchContent)
FetchContent_Declare(
        googletest
        GIT_REPOSITORY https://github.com/google/googletest
        BRANCH main
        GIT_TAG v1.17.0
)
FetchContent_MakeAvailable(googletest)

option(BUILD_STATIC_TESTING "Enable compile-time tests" ON)

function(create_test_target)
	set(oneValueArgs TARGET)
	set(multiValueArgs SOURCES)
    cmake_parse_arguments(
        PARSE_ARGV
        0
        "tests"
        ""
        "${oneValueArgs}"
        "${multiValueArgs}"
    )
	add_executable("${tests_TARGET}" ${tests_SOURCES})
	target_link_libraries("${tests_TARGET}" PRIVATE GTest::gtest_main)
	target_include_directories("${tests_TARGET}" SYSTEM PRIVATE "${googletest_SOURCE_DIR}/include")
	target_include_directories("${tests_TARGET}" PRIVATE "${CMAKE_CURRENT_SOURCE_DIR}/gtest_constexpr")
	include(GoogleTest)
	gtest_discover_tests("${tests_TARGET}")
endfunction()

if(CXX_COMPILER_ID STREQUAL Clang)
	add_compile_options(-fmacro-backtrace-limit=0)
endif()

if(BUILD_STATIC_TESTING)
	create_test_target(TARGET demo SOURCES Test.cpp)
endif()
create_test_target(TARGET relaxed_demo SOURCES Test.cpp)
target_compile_definitions(relaxed_demo PRIVATE "GTEST_CONFIG_RUNTIME_STATIC_EXPECT")
